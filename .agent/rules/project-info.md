---
trigger: always_on
---

# Smart Wallet & Payment Optimization AI Agent

## üéØ Project Overview

This project is a Golang-based microservice acting as an AI Payment Assistant. Its core mission is to help users find the best payment methods (cards, e-wallets) to maximize cashback and savings based on their current location, bank promotions, and merchant deals. It uses Firebase Genkit for AI orchestration, Echo for HTTP routing, and PostgreSQL (with PostGIS) for data storage.

## üõ† Tech Stack

- **Language:** Go (1.21+)
- **Web Framework:** Echo (`github.com/labstack/echo/v4`)
- **AI Orchestration:** Genkit (`github.com/firebase/genkit/go`)
- **Database & ORM:** PostgreSQL, PostGIS, `sqlc` (Type-safe SQL code generation), `pgxpool`
- **Authentication:** JWT with RS256 signature verification (`github.com/golang-jwt/jwt/v5`)
- **Context/Tooling:** Model Context Protocol (MCP) for external integrations.

## üìÅ Project Structure Architecture

- `cmd/server/main.go`: Application entry point. Bootstraps config, DB, Genkit, and Echo server.
- `internal/config/`: Environment variables and RS256 public key parsing.
- `internal/middleware/`: Echo middlewares (e.g., JWT RS256 validation).
- `internal/handler/`: HTTP delivery layer. Parses requests and calls services.
- `internal/service/`: Business logic and Genkit flow execution.
- `internal/ai/flow/`: Genkit flow definitions (e.g., `SmartWalletFlow`).
- `internal/ai/tool/`: Genkit tools (e.g., `GetDBTables`, `ExecuteSQL`, `FindNearbyDeals`).
- `internal/ai/mcp/`: Model Context Protocol integration clients/servers.
- `internal/ai/prompt/`: System instructions and prompt templates.
- `internal/repository/`: Data access layer.
  - `maindb/`: Generated by `sqlc` (deals, merchants, cards).
  - `chatdb/`: Generated by `sqlc` (chat history/memory).
- `db/queries/`: Raw `.sql` files used by `sqlc`.
- `db/migrations/`: SQL migration files.

## üíª Commands

- **Run Server:** `go run cmd/server/main.go`
- **Generate SQL Code:** `sqlc generate` (Run this every time `.sql` files in `db/queries/` change)
- **Download Dependencies:** `go mod tidy`
- **Run Tests:** `go test -v ./...`
- **Linting:** `golangci-lint run`

## üß† Development Guidelines & Idiomatic Go

### 1. Code Style

- Follow [Effective Go](https://go.dev/doc/effective_go) conventions.
- Keep functions small and focused. Avoid deeply nested `if` statements (return early).
- Use explicit error handling. Wrap errors with context: `fmt.Errorf("failed to fetch deals: %w", err)`.
- Always pass `context.Context` as the first argument to functions performing I/O, DB calls, or AI generation.

### 2. Database & `sqlc`

- **Never write inline SQL** in Go code. Always write raw SQL in `db/queries/` and run `sqlc generate`.
- Use `pgxpool` for database connections.
- **Spatial Queries:** For location-based features, strictly use PostGIS functions (e.g., `ST_DWithin`, `ST_MakePoint`) in the SQL queries.
- **Security:** Prevent SQL Injection. The AI tools MUST NOT construct raw SQL strings dynamically from user input. Always use parameterized queries or strictly validate inputs if dynamic queries are unavoidable (e.g., schema exploration).

### 3. AI Agent (Genkit) Rules

- **Tool Design:** Each tool in `internal/ai/tool/` must have a strict input/output schema defined using standard Go structs.
- **Context Injection:** `userId`, `lat`, and `lng` are injected by the system via the JWT middleware. The AI must never prompt the user for these explicitly if they are already provided in the context.
- **Privacy:** Never expose internal Database IDs, raw SQL, or another user's Personally Identifiable Information (PII) in the final AI response.
- **Hallucination Prevention:** The AI must rely solely on the data returned by the tools (DB records). If no deal is found, state it clearly.

### 4. Authentication (JWT RS256)

- The system relies on an asymmetric RS256 key pair.
- The API handler extracts the `userId` from the verified JWT token. **Never trust `userId` from the request body.** Pass this verified `userId` down to the Service and AI Flow layers.
